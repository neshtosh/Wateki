<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="images/wtki icon.png">
    <title>Wateki</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:200,300,400,600,700,800,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/flaticon.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        #blog-content {
            padding: 30px !important;
            color: #333 !important;
            background: #fff !important;
            font-size: 16px !important;
            line-height: 1.8 !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1) !important;
        }
        #blog-content h2 {
            color: #2c3e50 !important;
            font-size: 32px !important;
            font-weight: 700 !important;
            margin-bottom: 20px !important;
            line-height: 1.3 !important;
        }
        #blog-content img {
            display: block !important;
            max-width: 100% !important;
            height: auto !important;
            margin: 30px 0 !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
        }
        #blog-content p {
            margin-bottom: 20px !important;
            color: #555 !important;
        }
        #blog-content ul, #blog-content ol {
            margin: 20px 0 !important;
            padding-left: 20px !important;
        }
        #blog-content li {
            margin-bottom: 10px !important;
            color: #555 !important;
        }
        #blog-content blockquote {
            border-left: 4px solid #2c3e50 !important;
            padding: 15px 20px !important;
            margin: 20px 0 !important;
            background: #f8f9fa !important;
            font-style: italic !important;
        }
        #blog-content a {
            color: #2c3e50 !important;
            text-decoration: none !important;
            border-bottom: 1px solid #2c3e50 !important;
            transition: all 0.3s ease !important;
        }
        #blog-content a:hover {
            color: #3498db !important;
            border-bottom-color: #3498db !important;
        }
        /* --- Strong fix for comment form visibility --- */
        
        .comment-form-wrap:before,
        .comment-form-wrap:after {
            display: none !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
        <div class="container">
            <a class="navbar-brand" href="index.html">Wa<span>teki</span></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="oi oi-menu"></span> Menu
            </button>

            <div class="collapse navbar-collapse" id="ftco-nav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
                    <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
                    <li class="nav-item"><a href="work.html" class="nav-link">Work</a></li>
                    <li class="nav-item active"><a href="blog.html" class="nav-link">Blog</a></li>
                    <li class="nav-item"><a href="contact.html" class="nav-link">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <section class="hero-wrap hero-wrap-2 degree-right" style="background-image: url('images/blogsingle.jpg');" data-stellar-background-ratio="0.5">
        <div class="overlay"></div>
        <div class="container">
            <div class="row no-gutters slider-text js-fullheight align-items-end">
                <div class="col-md-9 ftco-animate pb-5 mb-5">
                    <p class="breadcrumbs"><span class="mr-2"><a href="index.html">Home <i class="fa fa-chevron-right"></i></a></span> <span class="mr-2"><a href="blog.html">Blog <i class="fa fa-chevron-right"></i></a></span> <span>Blog Single <i class="fa fa-chevron-right"></i></span></p>
                    <h1 class="mb-3 bread">Blog Single</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="ftco-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 ftco-animate">
                    <div id="blog-content">
                        <!-- Blog content will be dynamically loaded here -->
                    </div>

                    <div class="pt-5 mt-5">
                        <h3 class="mb-5">Comments</h3>
                        <ul class="comment-list">
                            <!-- Comments will be dynamically loaded here -->
                        </ul>

                        <div class="comment-form-wrap pt-5">
                            <h3 class="mb-5">Leave a comment</h3>
                            <form id="comment-form" class="p-5 ">
                                <div class="form-group">
                                    <label for="name">Name *</label>
                                    <input type="text" class="form-control" id="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email *</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="message">Comment</label>
                                    <textarea name="" id="message" cols="30" rows="10" class="form-control" required></textarea>
                                </div>
                                <div class="form-group">
                                    <input type="submit" value="Post Comment" class="btn py-3 px-4 btn-primary">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 sidebar ftco-animate">
                    <div class="sidebar-box">
                        <form action="#" class="search-form">
                            <div class="form-group">
                                <span class="icon fa fa-search"></span>
                                <input type="text" class="form-control" placeholder="Type a keyword and hit enter">
                            </div>
                    </form>
                    </div>
                    <div class="sidebar-box ftco-animate">
                        <h3 class="heading-sidebar">Recent Blog</h3>
                        <div id="recent-blogs-sidebar"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="ftco-footer ftco-section">
        <div class="container">
            <div class="row mb-5">
                <div class="col-md">
                    <div class="ftco-footer-widget mb-4">
                        <h2 class="ftco-heading-2">Wateki.</h2>
                        <p>Innovating for a Sustainable Future.</p>
                        <ul class="ftco-footer-social list-unstyled mt-5">
                            <li class="ftco-animate"><a href="#"><span class="fa fa-twitter"></span></a></li>
                            <li class="ftco-animate"><a href="#"><span class="fa fa-facebook"></span></a></li>
                            <li class="ftco-animate"><a href="#"><span class="fa fa-instagram"></span></a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md">
                    <div class="ftco-footer-widget mb-4 ml-md-4">
                        <h2 class="ftco-heading-2">Community</h2>
                        <ul class="list-unstyled">
                            <li><a href="work.html"><span class="fa fa-chevron-right mr-2"></span>Projects</a></li>
                            <li><a href="#"><span class="fa fa-chevron-right mr-2"></span>Team</a></li>
                            <li><a href="#"><span class="fa fa-chevron-right mr-2"></span>Reviews</a></li>
                            <li><a href="#"><span class="fa fa-chevron-right mr-2"></span>FAQs</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md">
                    <div class="ftco-footer-widget mb-4 ml-md-4">
                        <h2 class="ftco-heading-2">About Us</h2>
                        <ul class="list-unstyled">
                            <li><a href="#"><span class="fa fa-chevron-right mr-2"></span>Our Story</a></li>
                            <li><a href="#"><span class="fa fa-chevron-right mr-2"></span>Meet the team</a></li>
                            <li><a href="#"><span class="fa fa-chevron-right mr-2"></span>Careers</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md">
                    <div class="ftco-footer-widget mb-4">
                        <h2 class="ftco-heading-2">Company</h2>
                        <ul class="list-unstyled">
                            <li><a href="about.html"><span class="fa fa-chevron-right mr-2"></span>About Us</a></li>
                            <li><a href="#"><span class="fa fa-chevron-right mr-2"></span>Press</a></li>
                            <li><a href="contact.html"><span class="fa fa-chevron-right mr-2"></span>Contact</a></li>
                            <li><a href="#"><span class="fa fa-chevron-right mr-2"></span>Careers</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md">
                    <div class="ftco-footer-widget mb-4">
                        <h2 class="ftco-heading-2">Have a Questions?</h2>
                        <div class="block-23 mb-3">
                            <ul>
                                <li><span class="icon fa fa-map"></span><span class="text">Nairobi, Kenya</span></li>
                                <li><a href="#"><span class="icon fa fa-phone"></span><span class="text">+254 755 234 567</span></a></li>
                                <li><a href="#"><span class="icon fa fa-envelope pr-4"></span><span class="text">info@wateki.org</span></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 text-center">
                    <p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                        Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- loader -->
    <div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px"><circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/><circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00"/></svg></div>

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-migrate-3.0.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/jquery.stellar.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/jquery.animateNumber.min.js"></script>
    <script src="js/scrollax.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVWaKrjvy3MaE7SQ74_uJiULgl1JY0H2s&sensor=false"></script>
    <script src="js/google-map.js"></script>
    <script src="js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing WebSocket connection...');
            
            // Get the blog post ID from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id') || '1';
            console.log('Blog post ID:', postId);
            
            // Load the blog post content from server
            const blogContent = document.getElementById('blog-content');
            
            fetch(`/api/posts/${postId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Post not found');
                    return response.json();
                })
                .then(post => {
                    console.log('Fetched post:', post);
                    blogContent.innerHTML = `
                        <h2>${post.title}</h2>
                        <img src="${post.image}" alt="${post.title}" style="max-width:100%;margin-bottom:20px;">
                        <div>${post.content}</div>
                    `;
                    document.title = `${post.title} - Wateki`;
                })
                .catch((err) => {
                    blogContent.innerHTML = '<p>Blog post not found.</p>';
                    console.error('Error rendering post:', err);
                });

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}`;
            console.log('Connecting to WebSocket at:', wsUrl);
            
            const ws = new WebSocket(wsUrl);
            const commentForm = document.getElementById('comment-form');
            const commentList = document.querySelector('.comment-list');

            // Render comments and replies in a nested list
            function renderComments(comments) {
                commentList.innerHTML = '';
                // Build a map of comments by id
                const commentMap = {};
                comments.forEach(c => commentMap[c.id] = { ...c, replies: [] });
                // Build the tree
                const roots = [];
                comments.forEach(c => {
                    if (c.parentId) {
                        if (commentMap[c.parentId]) {
                            commentMap[c.parentId].replies.push(commentMap[c.id]);
                        }
                    } else {
                        roots.push(commentMap[c.id]);
                    }
                });
                // Render recursively
                function renderList(list, indent = 0) {
                    return list.map(comment => {
                        return `
                        <li class="comment" style="margin-left:${indent * 30}px">
                            <div class="comment-body">
                                <h3>${comment.author || comment.name || 'Anonymous'}</h3>
                                <div class="meta">${comment.date ? new Date(comment.date).toLocaleString() : ''}</div>
                                <p>${comment.content || comment.message}</p>
                                <button class="btn btn-sm btn-outline-primary reply-btn" data-id="${comment.id}">Reply</button>
                                <div class="reply-form-container" id="reply-form-${comment.id}"></div>
                            </div>
                            ${comment.replies.length > 0 ? `<ul class="children">${renderList(comment.replies, indent + 1)}</ul>` : ''}
                        </li>
                        `;
                    }).join('');
                }
                commentList.innerHTML = renderList(roots);
                // Attach reply button listeners
                document.querySelectorAll('.reply-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showReplyForm(this.getAttribute('data-id'));
                    });
                });
            }

            // Show reply form under a comment
            function showReplyForm(parentId) {
                // Remove any existing reply forms
                document.querySelectorAll('.reply-form-container').forEach(div => div.innerHTML = '');
                // Create reply form
                const container = document.getElementById('reply-form-' + parentId);
                if (!container) return;
                container.innerHTML = `
                    <form class="reply-form p-3 " onsubmit="return false;">
                        <div class="form-group">
                            <label for="reply-name">Name *</label>
                            <input type="text" class="form-control reply-name" required>
                        </div>
                        <div class="form-group">
                            <label for="reply-message">Comment</label>
                            <textarea class="form-control reply-message" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-sm">Post Reply</button>
                            <button type="button" class="btn btn-secondary btn-sm cancel-reply">Cancel</button>
                        </div>
                    </form>
                `;
                // Attach submit/cancel handlers
                container.querySelector('.reply-form').onsubmit = function(e) {
                    e.preventDefault();
                    const name = container.querySelector('.reply-name').value;
                    const message = container.querySelector('.reply-message').value;
                    if (!name || !message) return;
                    const reply = {
                        type: 'new_comment',
                        postId: postId,
                        author: name,
                        content: message,
                        parentId: parentId
                    };
                    ws.send(JSON.stringify(reply));
                    container.innerHTML = '';
                };
                container.querySelector('.cancel-reply').onclick = function() {
                    container.innerHTML = '';
                };
            }

            // Replace addComment to use renderComments
            function addComment() {
                // No-op, handled by renderComments
            }

            // Update WebSocket message handler to use renderComments
            ws.onmessage = function(event) {
                console.log('Received WebSocket message:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    console.log('Parsed message data:', data);
                    
                    if ((data.type === 'history' || data.type === 'comments') && data.postId === postId) {
                        console.log('Loading comment history:', data.comments.length, 'comments');
                        renderComments(data.comments);
                    } else if (data.type === 'new_comment' && data.postId === postId) {
                        // Server now broadcasts all comments on new_comment
                        renderComments(data.comments);
                    }
                } catch (error) {
                    console.error('Error processing message:', error);
                }
            };

            ws.onopen = function() {
                console.log('WebSocket connection established');
                // Show connection status
                const statusDiv = document.createElement('div');
                statusDiv.id = 'connection-status';
                statusDiv.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 1000;';
                statusDiv.textContent = 'Connected';
                document.body.appendChild(statusDiv);
                
                // Request comments for this blog post
                ws.send(JSON.stringify({
                    type: 'get_comments',
                    postId: postId
                }));
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                const statusDiv = document.getElementById('connection-status');
                if (statusDiv) {
                    statusDiv.style.background = '#f44336';
                    statusDiv.textContent = 'Connection Error';
                }
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
                const statusDiv = document.getElementById('connection-status');
                if (statusDiv) {
                    statusDiv.style.background = '#f44336';
                    statusDiv.textContent = 'Disconnected';
                }
            };

            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Comment form submitted');
                
                const name = document.getElementById('name').value;
                const message = document.getElementById('message').value;
                
                if (!name || !message) {
                    console.log('Form validation failed: missing required fields');
                    alert('Please fill in all required fields');
                    return;
                }
                
                const comment = {
                    type: 'new_comment',
                    postId: postId,
                    author: name,
                    content: message
                };
                
                try {
                    console.log('Sending comment:', comment);
                    ws.send(JSON.stringify(comment));
                    // Clear the form
                    commentForm.reset();
                } catch (error) {
                    console.error('Error sending comment:', error);
                    alert('Error sending comment. Please try again.');
                }
            });

            // After DOMContentLoaded, fetch and render recent blogs in sidebar
            fetch('/api/posts')
                .then(response => response.json())
                .then(posts => {
                    const recentBlogsSidebar = document.getElementById('recent-blogs-sidebar');
                    if (!recentBlogsSidebar) return;
                    // Convert posts object to array and sort by date descending
                    const postArr = Object.entries(posts)
                        .map(([id, post]) => ({ id, ...post }))
                        .filter(post => post.id !== postId) // Exclude current post
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    const top3 = postArr.slice(0, 3);
                    if (top3.length === 0) {
                        recentBlogsSidebar.innerHTML = '<p>No recent blogs available.</p>';
                        return;
                    }
                    recentBlogsSidebar.innerHTML = top3.map(post => `
                        <div class="block-21 mb-4 d-flex">
                            <a class="blog-img mr-4" style="background-image: url('${post.image}');"></a>
                            <div class="text">
                                <h3 class="heading"><a href="blog-single.html?id=${post.id}">${post.title}</a></h3>
                                <div class="meta">
                                    <div><a href="#"><span class="fa fa-calendar"></span> ${post.date ? new Date(post.date).toLocaleDateString() : ''}</a></div>
                                    <div><a href="#"><span class="fa fa-user"></span> Admin</a></div>
                                    <div><a href="#"><span class="fa fa-comment"></span> ${(post.comments ? post.comments.length : (post.commentCount || 0))}</a></div>
                                </div>
                            </div>
                        </div>
                    `).join('');
            });
        });
    </script>
</body>
</html>
